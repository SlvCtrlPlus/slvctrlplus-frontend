name: Deploy to Cloudflare Pages

on:
  workflow_run: # Using workflow_run trigger because release.published doesn't trigger
    workflows: ["Create Release"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download release asset
        uses: dsaltares/fetch-gh-release-asset@1.1.2
        with:
          file: 'dist.tar.gz'
          target: 'dist.tar.gz'
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Create dist directory
        run: mkdir -p dist
      - name: Extract asset
        run: tar -xzf dist.tar.gz -C dist
      - name: Upload to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ vars.CF_ACCOUNT_ID }}
          projectName: ${{ vars.CF_PROJECT_NAME }}
          directory: ./dist
